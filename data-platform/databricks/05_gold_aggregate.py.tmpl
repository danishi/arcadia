# ==============================================================================
# ARCADIA Data Platform - Databricks Gold Aggregation
# Generated by ARCADIA Framework (Phase F)
#
# Applies business logic to Silver tables and creates Gold aggregated tables.
# Gold tables are optimized for analytics, dashboards, and AI/ML consumption.
#
# Gold Tables:
#   - customer_360:            Unified customer view (all data in one record)
#   - campaign_effectiveness:  Campaign performance KPIs
#   - daily_summary:           Daily transaction summary (dashboard-ready)
#   - segment_analysis:        Customer segment analysis
# ==============================================================================

# Databricks notebook source

# MAGIC %md
# MAGIC # 05. Gold Layer Aggregation (Silver -> Gold)
# MAGIC Apply business logic and create aggregated tables for analytics.
# MAGIC
# MAGIC | Table | Purpose |
# MAGIC |-------|---------|
# MAGIC | customer_360 | Unified customer view (360-degree) |
# MAGIC | campaign_effectiveness | Campaign ROI and funnel analysis |
# MAGIC | daily_summary | Daily transaction KPIs |
# MAGIC | segment_analysis | Customer segment breakdown |

# COMMAND ----------

# MAGIC %run ../common/00_config

# COMMAND ----------

CATALOG = catalog_name()

# COMMAND ----------

# MAGIC %md
# MAGIC ## 1. Customer 360 View
# MAGIC Integrates: customer master + account aggregation + transaction aggregation
# MAGIC + web behavior + campaign response

# COMMAND ----------

spark.sql(f"""
    CREATE OR REPLACE TABLE {fqn(SCHEMA_GOLD, 'customer_360')}
    USING DELTA
    COMMENT 'Customer 360-degree unified view - all channels and products'
    AS
    WITH account_agg AS (
        SELECT
            customer_id,
            COUNT(*) AS num_accounts,
            SUM(balance) AS total_balance,
            SUM(CASE WHEN balance > 0 THEN balance ELSE 0 END) AS deposit_balance,
            SUM(CASE WHEN balance < 0 THEN balance ELSE 0 END) AS loan_balance,
            CONCAT_WS(', ', COLLECT_SET(account_type)) AS account_types
        FROM {fqn(SCHEMA_SILVER, 'accounts')}
        GROUP BY customer_id
    ),
    tx_agg AS (
        SELECT
            a.customer_id,
            COUNT(*) AS tx_count,
            SUM(CASE WHEN t.amount > 0 THEN t.amount ELSE 0 END) AS tx_total_credit,
            SUM(CASE WHEN t.amount < 0 THEN ABS(t.amount) ELSE 0 END) AS tx_total_debit,
            MAX(t.transaction_date) AS last_tx_date,
            MODE(t.channel) AS primary_channel
        FROM {fqn(SCHEMA_SILVER, 'transactions')} t
        JOIN {fqn(SCHEMA_SILVER, 'accounts')} a ON t.account_id = a.account_id
        GROUP BY a.customer_id
    ),
    web_agg AS (
        SELECT
            customer_id,
            COUNT(*) AS page_views,
            COUNT(DISTINCT session_id) AS sessions,
            MAX(CAST(event_timestamp AS DATE)) AS last_visit_date,
            MODE(device_type) AS primary_device
        FROM {fqn(SCHEMA_SILVER, 'web_events')}
        WHERE customer_id IS NOT NULL
        GROUP BY customer_id
    ),
    cp_agg AS (
        SELECT
            customer_id,
            COUNT(*) AS campaigns_received,
            SUM(opened) AS campaigns_opened,
            SUM(clicked) AS campaigns_clicked,
            SUM(converted) AS campaigns_converted
        FROM {fqn(SCHEMA_SILVER, 'campaign_responses')}
        GROUP BY customer_id
    )
    SELECT
        c.customer_id,
        c.name,
        c.email,
        c.birth_date,
        FLOOR(DATEDIFF(CURRENT_DATE(), c.birth_date) / 365.25) AS age,
        c.gender,
        c.region,
        c.registration_date,
        c.segment,
        c.status,
        -- Account metrics
        COALESCE(acc.num_accounts, 0)     AS num_accounts,
        COALESCE(acc.total_balance, 0)    AS total_balance,
        COALESCE(acc.deposit_balance, 0)  AS deposit_balance,
        COALESCE(acc.loan_balance, 0)     AS loan_balance,
        acc.account_types,
        -- Transaction metrics (12 months)
        COALESCE(tx.tx_count, 0)          AS tx_count_12m,
        COALESCE(tx.tx_total_credit, 0)   AS tx_total_credit_12m,
        COALESCE(tx.tx_total_debit, 0)    AS tx_total_debit_12m,
        tx.last_tx_date,
        tx.primary_channel,
        -- Web behavior (90 days)
        COALESCE(web.page_views, 0)       AS web_page_views_90d,
        COALESCE(web.sessions, 0)         AS web_sessions_90d,
        web.last_visit_date,
        web.primary_device,
        -- Campaign engagement
        COALESCE(cp.campaigns_received, 0)  AS campaigns_received,
        COALESCE(cp.campaigns_opened, 0)    AS campaigns_opened,
        COALESCE(cp.campaigns_clicked, 0)   AS campaigns_clicked,
        COALESCE(cp.campaigns_converted, 0) AS campaigns_converted,
        CASE
            WHEN COALESCE(cp.campaigns_received, 0) = 0 THEN 0.0
            ELSE ROUND(cp.campaigns_opened * 100.0 / cp.campaigns_received, 2)
        END AS open_rate,
        current_timestamp() AS _refresh_timestamp
    FROM {fqn(SCHEMA_SILVER, 'customers')} c
    LEFT JOIN account_agg acc ON c.customer_id = acc.customer_id
    LEFT JOIN tx_agg tx ON c.customer_id = tx.customer_id
    LEFT JOIN web_agg web ON c.customer_id = web.customer_id
    LEFT JOIN cp_agg cp ON c.customer_id = cp.customer_id
""")

cnt = spark.table(fqn(SCHEMA_GOLD, 'customer_360')).count()
print_status("1/4", f"Customer 360 View: {cnt:,} records")

# COMMAND ----------

# MAGIC %md
# MAGIC ## 2. Campaign Effectiveness

# COMMAND ----------

spark.sql(f"""
    CREATE OR REPLACE TABLE {fqn(SCHEMA_GOLD, 'campaign_effectiveness')}
    USING DELTA
    COMMENT 'Campaign effectiveness analysis with funnel metrics and ROI'
    AS
    SELECT
        cp.campaign_id,
        cp.campaign_name,
        cp.channel,
        cp.start_date,
        cp.end_date,
        cp.target_segment,
        cp.budget,
        cp.status,
        COALESCE(r.total_sent, 0)       AS total_sent,
        COALESCE(r.total_delivered, 0)   AS total_delivered,
        COALESCE(r.total_opened, 0)     AS total_opened,
        COALESCE(r.total_clicked, 0)    AS total_clicked,
        COALESCE(r.total_converted, 0)  AS total_converted,
        COALESCE(r.total_revenue, 0)    AS total_revenue,
        -- Funnel KPIs
        CASE WHEN COALESCE(r.total_sent, 0) = 0 THEN 0.0
             ELSE ROUND(r.total_delivered * 100.0 / r.total_sent, 2)
        END AS delivery_rate,
        CASE WHEN COALESCE(r.total_delivered, 0) = 0 THEN 0.0
             ELSE ROUND(r.total_opened * 100.0 / r.total_delivered, 2)
        END AS open_rate,
        CASE WHEN COALESCE(r.total_opened, 0) = 0 THEN 0.0
             ELSE ROUND(r.total_clicked * 100.0 / r.total_opened, 2)
        END AS click_rate,
        CASE WHEN COALESCE(r.total_clicked, 0) = 0 THEN 0.0
             ELSE ROUND(r.total_converted * 100.0 / r.total_clicked, 2)
        END AS conversion_rate,
        -- ROI
        CASE WHEN cp.budget = 0 THEN 0.0
             ELSE ROUND((COALESCE(r.total_revenue, 0) - cp.budget) * 100.0 / cp.budget, 2)
        END AS roi_pct,
        current_timestamp() AS _refresh_timestamp
    FROM {fqn(SCHEMA_SILVER, 'campaigns')} cp
    LEFT JOIN (
        SELECT
            campaign_id,
            COUNT(*) AS total_sent,
            SUM(delivered) AS total_delivered,
            SUM(opened) AS total_opened,
            SUM(clicked) AS total_clicked,
            SUM(converted) AS total_converted,
            SUM(conversion_amount) AS total_revenue
        FROM {fqn(SCHEMA_SILVER, 'campaign_responses')}
        GROUP BY campaign_id
    ) r ON cp.campaign_id = r.campaign_id
""")

cnt = spark.table(fqn(SCHEMA_GOLD, 'campaign_effectiveness')).count()
print_status("2/4", f"Campaign Effectiveness: {cnt:,} records")

# COMMAND ----------

# MAGIC %md
# MAGIC ## 3. Daily Transaction Summary

# COMMAND ----------

spark.sql(f"""
    CREATE OR REPLACE TABLE {fqn(SCHEMA_GOLD, 'daily_summary')}
    USING DELTA
    COMMENT 'Daily transaction summary for dashboards'
    AS
    SELECT
        t.transaction_date,
        t.transaction_type,
        t.channel,
        COUNT(*) AS tx_count,
        SUM(CASE WHEN t.amount > 0 THEN t.amount ELSE 0 END) AS total_credit,
        SUM(CASE WHEN t.amount < 0 THEN ABS(t.amount) ELSE 0 END) AS total_debit,
        COUNT(DISTINCT t.account_id) AS unique_accounts,
        COUNT(DISTINCT a.customer_id) AS unique_customers,
        AVG(ABS(t.amount)) AS avg_amount
    FROM {fqn(SCHEMA_SILVER, 'transactions')} t
    JOIN {fqn(SCHEMA_SILVER, 'accounts')} a ON t.account_id = a.account_id
    GROUP BY t.transaction_date, t.transaction_type, t.channel
    ORDER BY t.transaction_date DESC
""")

cnt = spark.table(fqn(SCHEMA_GOLD, 'daily_summary')).count()
print_status("3/4", f"Daily Summary: {cnt:,} records")

# COMMAND ----------

# MAGIC %md
# MAGIC ## 4. Segment Analysis
# MAGIC Customer segment breakdown with balance, activity, and engagement metrics.

# COMMAND ----------

spark.sql(f"""
    CREATE OR REPLACE TABLE {fqn(SCHEMA_GOLD, 'segment_analysis')}
    USING DELTA
    COMMENT 'Customer segment analysis with multi-dimensional metrics'
    AS
    SELECT
        c.segment,
        c.region,
        COUNT(*) AS customer_count,
        -- Balance statistics
        AVG(COALESCE(acc.total_balance, 0)) AS avg_total_balance,
        PERCENTILE_APPROX(COALESCE(acc.total_balance, 0), 0.5) AS median_total_balance,
        -- Transaction activity
        AVG(COALESCE(tx.tx_count, 0)) AS avg_tx_count,
        -- Web activity
        AVG(COALESCE(web.page_views, 0)) AS avg_web_views,
        -- Campaign engagement
        CASE
            WHEN SUM(COALESCE(cp.campaigns_received, 0)) = 0 THEN 0.0
            ELSE ROUND(SUM(COALESCE(cp.campaigns_converted, 0)) * 100.0
                       / SUM(COALESCE(cp.campaigns_received, 0)), 2)
        END AS avg_conversion_rate
    FROM {fqn(SCHEMA_SILVER, 'customers')} c
    LEFT JOIN (
        SELECT customer_id, SUM(balance) AS total_balance
        FROM {fqn(SCHEMA_SILVER, 'accounts')}
        GROUP BY customer_id
    ) acc ON c.customer_id = acc.customer_id
    LEFT JOIN (
        SELECT a.customer_id, COUNT(*) AS tx_count
        FROM {fqn(SCHEMA_SILVER, 'transactions')} t
        JOIN {fqn(SCHEMA_SILVER, 'accounts')} a ON t.account_id = a.account_id
        GROUP BY a.customer_id
    ) tx ON c.customer_id = tx.customer_id
    LEFT JOIN (
        SELECT customer_id, COUNT(*) AS page_views
        FROM {fqn(SCHEMA_SILVER, 'web_events')}
        WHERE customer_id IS NOT NULL
        GROUP BY customer_id
    ) web ON c.customer_id = web.customer_id
    LEFT JOIN (
        SELECT customer_id,
               COUNT(*) AS campaigns_received,
               SUM(converted) AS campaigns_converted
        FROM {fqn(SCHEMA_SILVER, 'campaign_responses')}
        GROUP BY customer_id
    ) cp ON c.customer_id = cp.customer_id
    WHERE c.status = 'active'
    GROUP BY c.segment, c.region
    ORDER BY c.segment, c.region
""")

cnt = spark.table(fqn(SCHEMA_GOLD, 'segment_analysis')).count()
print_status("4/4", f"Segment Analysis: {cnt:,} records")

# COMMAND ----------

# MAGIC %md
# MAGIC ## Gold Layer Summary

# COMMAND ----------

print("=" * 60)
print("  Gold Layer - Aggregation Complete")
print("=" * 60)
for t in GOLD_TABLES:
    full_name = fqn(SCHEMA_GOLD, t)
    cnt = spark.table(full_name).count()
    cols = len(spark.table(full_name).columns)
    print(f"  {t:<28s} : {cnt:>6,} records  ({cols} columns)")
print("=" * 60)
