# ==============================================================================
# ARCADIA Data Platform - Databricks Silver Transformation
# Generated by ARCADIA Framework (Phase F)
#
# Transforms Bronze raw data into Silver cleansed tables.
# Operations: type casting, deduplication, null handling, data quality checks.
#
# Method: MERGE INTO (idempotent, incremental update)
#   - Same-key records are updated, new records are inserted
#   - Data quality expectations are enforced via SQL checks
# ==============================================================================

# Databricks notebook source

# MAGIC %md
# MAGIC # 04. Silver Layer Transformation (Bronze -> Silver)
# MAGIC Cleanse, type-cast, deduplicate, and merge into Silver Delta tables.
# MAGIC
# MAGIC **Method: MERGE INTO** (idempotent, incremental)

# COMMAND ----------

# MAGIC %run ../common/00_config

# COMMAND ----------

CATALOG = catalog_name()

# COMMAND ----------

# MAGIC %md
# MAGIC ## 1. Customers

# COMMAND ----------

spark.sql(f"""
    CREATE OR REPLACE TABLE {fqn(SCHEMA_SILVER, 'customers')} (
        customer_id       STRING    NOT NULL,
        name              STRING,
        email             STRING,
        birth_date        DATE,
        gender            STRING,
        region            STRING,
        registration_date DATE,
        segment           STRING,
        status            STRING,
        _load_timestamp   TIMESTAMP
    )
    USING DELTA
    COMMENT 'Cleansed customer master'
    TBLPROPERTIES ('quality.expectation.customer_id' = 'IS NOT NULL')
""")

spark.sql(f"""
    MERGE INTO {fqn(SCHEMA_SILVER, 'customers')} AS tgt
    USING (
        SELECT DISTINCT
            customer_id,
            name,
            email,
            CAST(birth_date AS DATE) AS birth_date,
            gender,
            region,
            CAST(registration_date AS DATE) AS registration_date,
            segment,
            status,
            current_timestamp() AS _load_timestamp
        FROM {fqn(SCHEMA_BRONZE, 'raw_customers')}
        WHERE customer_id IS NOT NULL
    ) AS src
    ON tgt.customer_id = src.customer_id
    WHEN MATCHED THEN UPDATE SET *
    WHEN NOT MATCHED THEN INSERT *
""")

cnt = spark.table(fqn(SCHEMA_SILVER, 'customers')).count()
print_status("1/6", f"Customers: {cnt:,} records")

# COMMAND ----------

# MAGIC %md
# MAGIC ## 2. Accounts

# COMMAND ----------

spark.sql(f"""
    CREATE OR REPLACE TABLE {fqn(SCHEMA_SILVER, 'accounts')} (
        account_id      STRING    NOT NULL,
        customer_id     STRING    NOT NULL,
        account_type    STRING,
        open_date       DATE,
        balance         BIGINT,
        status          STRING,
        currency        STRING,
        _load_timestamp TIMESTAMP
    )
    USING DELTA
    COMMENT 'Cleansed account table'
""")

spark.sql(f"""
    MERGE INTO {fqn(SCHEMA_SILVER, 'accounts')} AS tgt
    USING (
        SELECT DISTINCT
            account_id,
            customer_id,
            account_type,
            CAST(open_date AS DATE) AS open_date,
            CAST(balance AS BIGINT) AS balance,
            status,
            currency,
            current_timestamp() AS _load_timestamp
        FROM {fqn(SCHEMA_BRONZE, 'raw_accounts')}
        WHERE account_id IS NOT NULL
    ) AS src
    ON tgt.account_id = src.account_id
    WHEN MATCHED THEN UPDATE SET *
    WHEN NOT MATCHED THEN INSERT *
""")

cnt = spark.table(fqn(SCHEMA_SILVER, 'accounts')).count()
print_status("2/6", f"Accounts: {cnt:,} records")

# COMMAND ----------

# MAGIC %md
# MAGIC ## 3. Transactions

# COMMAND ----------

spark.sql(f"""
    CREATE OR REPLACE TABLE {fqn(SCHEMA_SILVER, 'transactions')} (
        transaction_id    STRING    NOT NULL,
        account_id        STRING    NOT NULL,
        transaction_date  DATE,
        transaction_type  STRING,
        amount            BIGINT,
        balance_after     BIGINT,
        channel           STRING,
        description       STRING,
        _load_timestamp   TIMESTAMP
    )
    USING DELTA
    COMMENT 'Cleansed transaction table'
    CLUSTER BY (transaction_date)
""")

spark.sql(f"""
    MERGE INTO {fqn(SCHEMA_SILVER, 'transactions')} AS tgt
    USING (
        SELECT DISTINCT
            transaction_id,
            account_id,
            CAST(transaction_date AS DATE) AS transaction_date,
            transaction_type,
            CAST(amount AS BIGINT) AS amount,
            CAST(balance_after AS BIGINT) AS balance_after,
            channel,
            description,
            current_timestamp() AS _load_timestamp
        FROM {fqn(SCHEMA_BRONZE, 'raw_transactions')}
        WHERE transaction_id IS NOT NULL
    ) AS src
    ON tgt.transaction_id = src.transaction_id
    WHEN MATCHED THEN UPDATE SET *
    WHEN NOT MATCHED THEN INSERT *
""")

cnt = spark.table(fqn(SCHEMA_SILVER, 'transactions')).count()
print_status("3/6", f"Transactions: {cnt:,} records")

# COMMAND ----------

# MAGIC %md
# MAGIC ## 4. Campaigns

# COMMAND ----------

spark.sql(f"""
    CREATE OR REPLACE TABLE {fqn(SCHEMA_SILVER, 'campaigns')} (
        campaign_id     STRING    NOT NULL,
        campaign_name   STRING,
        channel         STRING,
        start_date      DATE,
        end_date        DATE,
        target_segment  STRING,
        budget          BIGINT,
        status          STRING,
        _load_timestamp TIMESTAMP
    )
    USING DELTA
    COMMENT 'Cleansed campaign master'
""")

spark.sql(f"""
    MERGE INTO {fqn(SCHEMA_SILVER, 'campaigns')} AS tgt
    USING (
        SELECT DISTINCT
            campaign_id,
            campaign_name,
            channel,
            CAST(start_date AS DATE) AS start_date,
            CAST(end_date AS DATE) AS end_date,
            target_segment,
            CAST(budget AS BIGINT) AS budget,
            status,
            current_timestamp() AS _load_timestamp
        FROM {fqn(SCHEMA_BRONZE, 'raw_campaigns')}
        WHERE campaign_id IS NOT NULL
    ) AS src
    ON tgt.campaign_id = src.campaign_id
    WHEN MATCHED THEN UPDATE SET *
    WHEN NOT MATCHED THEN INSERT *
""")

cnt = spark.table(fqn(SCHEMA_SILVER, 'campaigns')).count()
print_status("4/6", f"Campaigns: {cnt:,} records")

# COMMAND ----------

# MAGIC %md
# MAGIC ## 5. Campaign Responses

# COMMAND ----------

spark.sql(f"""
    CREATE OR REPLACE TABLE {fqn(SCHEMA_SILVER, 'campaign_responses')} (
        response_id       STRING    NOT NULL,
        campaign_id       STRING    NOT NULL,
        customer_id       STRING    NOT NULL,
        sent_date         DATE,
        channel           STRING,
        delivered         INT,
        opened            INT,
        clicked           INT,
        converted         INT,
        conversion_amount BIGINT,
        _load_timestamp   TIMESTAMP
    )
    USING DELTA
    COMMENT 'Cleansed campaign response table'
""")

spark.sql(f"""
    MERGE INTO {fqn(SCHEMA_SILVER, 'campaign_responses')} AS tgt
    USING (
        SELECT DISTINCT
            response_id,
            campaign_id,
            customer_id,
            CAST(sent_date AS DATE) AS sent_date,
            channel,
            CAST(delivered AS INT) AS delivered,
            CAST(opened AS INT) AS opened,
            CAST(clicked AS INT) AS clicked,
            CAST(converted AS INT) AS converted,
            CAST(conversion_amount AS BIGINT) AS conversion_amount,
            current_timestamp() AS _load_timestamp
        FROM {fqn(SCHEMA_BRONZE, 'raw_campaign_responses')}
        WHERE response_id IS NOT NULL
    ) AS src
    ON tgt.response_id = src.response_id
    WHEN MATCHED THEN UPDATE SET *
    WHEN NOT MATCHED THEN INSERT *
""")

cnt = spark.table(fqn(SCHEMA_SILVER, 'campaign_responses')).count()
print_status("5/6", f"Campaign Responses: {cnt:,} records")

# COMMAND ----------

# MAGIC %md
# MAGIC ## 6. Web Events

# COMMAND ----------

spark.sql(f"""
    CREATE OR REPLACE TABLE {fqn(SCHEMA_SILVER, 'web_events')} (
        session_id      STRING,
        customer_id     STRING,
        event_timestamp TIMESTAMP,
        page_url        STRING,
        event_type      STRING,
        device_type     STRING,
        referrer        STRING,
        _load_timestamp TIMESTAMP
    )
    USING DELTA
    COMMENT 'Cleansed web event table'
    CLUSTER BY (event_type)
""")

spark.sql(f"""
    MERGE INTO {fqn(SCHEMA_SILVER, 'web_events')} AS tgt
    USING (
        SELECT DISTINCT
            session_id,
            NULLIF(customer_id, 'null') AS customer_id,
            CAST(timestamp AS TIMESTAMP) AS event_timestamp,
            page_url,
            event_type,
            device_type,
            referrer,
            current_timestamp() AS _load_timestamp
        FROM {fqn(SCHEMA_BRONZE, 'raw_web_events')}
        WHERE session_id IS NOT NULL
    ) AS src
    ON tgt.session_id = src.session_id
       AND tgt.event_timestamp = src.event_timestamp
    WHEN MATCHED THEN UPDATE SET *
    WHEN NOT MATCHED THEN INSERT *
""")

cnt = spark.table(fqn(SCHEMA_SILVER, 'web_events')).count()
print_status("6/6", f"Web Events: {cnt:,} records")

# COMMAND ----------

# MAGIC %md
# MAGIC ## Data Quality Report

# COMMAND ----------

print("=" * 60)
print("  Silver Layer - Data Quality Report")
print("=" * 60)

# Customers: NULL check
null_cust = spark.sql(f"""
    SELECT COUNT(*) AS cnt FROM {fqn(SCHEMA_SILVER, 'customers')}
    WHERE customer_id IS NULL OR name IS NULL
""").first().cnt
print(f"  Customer NULL violations   : {null_cust}")

# Accounts: orphan record check
orphan_acc = spark.sql(f"""
    SELECT COUNT(*) AS cnt FROM {fqn(SCHEMA_SILVER, 'accounts')} a
    LEFT JOIN {fqn(SCHEMA_SILVER, 'customers')} c ON a.customer_id = c.customer_id
    WHERE c.customer_id IS NULL
""").first().cnt
print(f"  Account orphan records     : {orphan_acc}")

# Transactions: zero amount check
zero_tx = spark.sql(f"""
    SELECT COUNT(*) AS cnt FROM {fqn(SCHEMA_SILVER, 'transactions')}
    WHERE amount = 0
""").first().cnt
print(f"  Transaction zero-amount    : {zero_tx}")

# Campaign responses: funnel consistency (clicked > opened is invalid)
funnel_err = spark.sql(f"""
    SELECT COUNT(*) AS cnt FROM {fqn(SCHEMA_SILVER, 'campaign_responses')}
    WHERE clicked = 1 AND opened = 0
""").first().cnt
print(f"  Campaign funnel violations : {funnel_err}")

print("=" * 60)
print("  Quality check complete")
print("=" * 60)
