# ==============================================================================
# ARCADIA Data Platform - Sample Data Generator
# Generated by ARCADIA Framework (Phase F)
#
# Platform-independent sample data generation.
# Outputs CSV/JSON files that can be ingested by any data platform.
#
# Usage:
#   python 02_generate_sample_data.py
#
# Output:
#   ./output/{PROJECT_SLUG}/raw/
#     customers/customers.csv
#     accounts/accounts.csv
#     transactions/transactions.csv
#     campaigns/campaigns.csv
#     campaign_responses/campaign_responses.csv
#     web_events/web_events.json
#
# Dependencies:
#   pip install faker   (optional - falls back to built-in random data)
# ==============================================================================

import csv
import json
import os
import random
import sys
from datetime import datetime, timedelta, date

# Import config (adjust path if needed)
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
from importlib import util as importlib_util

# Try to load config; fall back to defaults if not found
try:
    import importlib
    config = importlib.import_module("00_config")
    PROJECT_SLUG = config.PROJECT_SLUG
    NUM_CUSTOMERS = config.NUM_CUSTOMERS
    NUM_ACCOUNTS = config.NUM_ACCOUNTS
    NUM_TRANSACTIONS = config.NUM_TRANSACTIONS
    NUM_CAMPAIGNS = config.NUM_CAMPAIGNS
    NUM_CAMPAIGN_RESPONSES = config.NUM_CAMPAIGN_RESPONSES
    NUM_WEB_EVENTS = config.NUM_WEB_EVENTS
    RANDOM_SEED = config.RANDOM_SEED
    print_status = config.print_status
except ImportError:
    PROJECT_SLUG = "demo"
    NUM_CUSTOMERS = 200
    NUM_ACCOUNTS = 500
    NUM_TRANSACTIONS = 10000
    NUM_CAMPAIGNS = 15
    NUM_CAMPAIGN_RESPONSES = 3000
    NUM_WEB_EVENTS = 5000
    RANDOM_SEED = 42

    def print_status(step, message, success=True):
        icon = "[OK]" if success else "[NG]"
        print(f"{icon} [{step}] {message}")

random.seed(RANDOM_SEED)

# ==============================================================================
# Output directory
# ==============================================================================

OUTPUT_DIR = os.path.join(os.path.dirname(os.path.abspath(__file__)), "output", PROJECT_SLUG, "raw")

def ensure_dir(subdir: str) -> str:
    """Create output subdirectory and return its path."""
    path = os.path.join(OUTPUT_DIR, subdir)
    os.makedirs(path, exist_ok=True)
    return path


# ==============================================================================
# Master Data Definitions
# ==============================================================================
# CUSTOMIZE: Replace these lists with domain-appropriate values for your project.
# The lists below are generic banking/finance examples.

# --- Customer names (Japanese example; replace with Faker for i18n) ---
SURNAMES = [
    "Tanaka", "Suzuki", "Sato", "Takahashi", "Watanabe",
    "Ito", "Yamamoto", "Nakamura", "Kobayashi", "Kato",
    "Yoshida", "Yamada", "Matsumoto", "Inoue", "Kimura",
    "Hayashi", "Shimizu", "Yamazaki", "Mori", "Ikeda",
]
GIVEN_NAMES = [
    "Taro", "Ichiro", "Kenta", "Daisuke", "Shota",
    "Hanako", "Misaki", "Yumi", "Ai", "Sakura",
    "Naoki", "Takuya", "Tatsuya", "Kazuya", "Koji",
    "Mayumi", "Yuko", "Megumi", "Akemi", "Yoko",
]

REGIONS = [
    "Tokyo", "Osaka", "Kanagawa", "Aichi", "Saitama",
    "Chiba", "Hyogo", "Fukuoka", "Hokkaido", "Kyoto",
]

ACCOUNT_TYPES = ["savings", "term_deposit", "foreign_currency", "card_loan", "mortgage"]
TX_TYPES = ["transfer", "deposit", "withdrawal", "direct_debit", "atm_deposit", "atm_withdrawal", "interest", "fee"]
CHANNELS = ["online_banking", "atm", "branch", "mobile_app", "api"]
SEGMENTS = ["mass", "upper_mass", "affluent", "young", "senior"]

# --- Campaign definitions (generic) ---
# CUSTOMIZE: Add your own campaigns here
CAMPAIGN_DEFS = [
    ("CP001", "Mortgage Rate Discount Campaign", "email"),
    ("CP002", "Foreign Currency Cashback", "push"),
    ("CP003", "New Account Opening Bonus", "sms"),
    ("CP004", "Loyalty Tier Upgrade", "email"),
    ("CP005", "Term Deposit Rate Boost", "email"),
    ("CP006", "Card Loan Rate Promotion", "push"),
    ("CP007", "Partner Points Campaign", "push"),
    ("CP008", "Investment Fund Campaign", "email"),
    ("CP009", "Salary Account Setup Bonus", "sms"),
    ("CP010", "Referral Program", "email"),
    ("CP011", "FX Account Opening Campaign", "push"),
    ("CP012", "Partner Integration Special", "email"),
    ("CP013", "Year-End Asset Building", "email"),
    ("CP014", "Spring New Life Support", "sms"),
    ("CP015", "Premium Plan Promotion", "push"),
]


# ==============================================================================
# 1. Customer Data
# ==============================================================================

def generate_customers():
    """Generate customer master data."""
    rows = []
    base_date = date(2015, 1, 1)
    today = date.today()

    for i in range(1, NUM_CUSTOMERS + 1):
        gender = random.choice(["M", "F"])
        surname = random.choice(SURNAMES)
        given = random.choice(GIVEN_NAMES)
        name = f"{surname} {given}"
        email = f"{given.lower()}.{surname.lower()}{i}@example.com"

        birth_year = random.randint(1955, 2003)
        birth = date(birth_year, random.randint(1, 12), random.randint(1, 28))

        # 80% existing customers (2015-), 20% recent (last 6 months)
        if random.random() < 0.2:
            recent_start = today - timedelta(days=180)
            reg_date = recent_start + timedelta(days=random.randint(0, 180))
        else:
            reg_date = base_date + timedelta(days=random.randint(0, (today - base_date).days))

        rows.append({
            "customer_id": f"CUST{i:05d}",
            "name": name,
            "email": email,
            "birth_date": birth.isoformat(),
            "gender": gender,
            "region": random.choice(REGIONS),
            "registration_date": reg_date.isoformat(),
            "segment": random.choices(SEGMENTS, weights=[35, 25, 10, 20, 10])[0],
            "status": random.choices(["active", "dormant", "closed"], weights=[85, 10, 5])[0],
        })
    return rows


# ==============================================================================
# 2. Account Data
# ==============================================================================

def generate_accounts(customers):
    """Generate account data linked to customers."""
    rows = []
    aid = 1
    for c in customers:
        if c["status"] == "closed":
            continue
        n = random.choices([1, 2, 3, 4], weights=[30, 40, 20, 10])[0]
        types_chosen = random.sample(ACCOUNT_TYPES, min(n, len(ACCOUNT_TYPES)))
        for atype in types_chosen:
            balance = {
                "savings": random.randint(10000, 50000000),
                "term_deposit": random.randint(1000000, 100000000),
                "foreign_currency": random.randint(100000, 30000000),
                "card_loan": -random.randint(100000, 5000000),
                "mortgage": -random.randint(10000000, 80000000),
            }[atype]
            rows.append({
                "account_id": f"ACC{aid:06d}",
                "customer_id": c["customer_id"],
                "account_type": atype,
                "open_date": c["registration_date"],
                "balance": balance,
                "status": "active" if c["status"] == "active" else "inactive",
                "currency": "USD" if atype == "foreign_currency" else "JPY",
            })
            aid += 1
    return rows


# ==============================================================================
# 3. Transaction Data
# ==============================================================================

def generate_transactions(accounts):
    """Generate transaction history for active accounts."""
    rows = []
    active_accounts = [a for a in accounts if a["status"] == "active" and a["balance"] > 0]
    if not active_accounts:
        active_accounts = [a for a in accounts if a["status"] == "active"]

    today = date.today()
    start_date = today - timedelta(days=365)

    for i in range(1, NUM_TRANSACTIONS + 1):
        acc = random.choice(active_accounts)
        tx_date = start_date + timedelta(days=random.randint(0, 365))
        tx_type = random.choices(TX_TYPES, weights=[20, 20, 15, 15, 10, 10, 5, 5])[0]

        if tx_type in ("deposit", "atm_deposit", "interest"):
            amount = random.randint(1000, 5000000)
        elif tx_type == "fee":
            amount = -random.choice([110, 220, 330, 440, 550, 770])
        else:
            amount = -random.randint(1000, 3000000)

        rows.append({
            "transaction_id": f"TX{i:08d}",
            "account_id": acc["account_id"],
            "transaction_date": tx_date.isoformat(),
            "transaction_type": tx_type,
            "amount": amount,
            "balance_after": acc["balance"] + amount,
            "channel": random.choice(CHANNELS),
            "description": f"{tx_type} (auto-generated)",
        })
    return rows


# ==============================================================================
# 4. Campaign Data
# ==============================================================================

def generate_campaigns():
    """Generate campaign master data."""
    rows = []
    current_year = date.today().year
    for cid, name, channel in CAMPAIGN_DEFS[:NUM_CAMPAIGNS]:
        start = date(current_year - 1, random.randint(1, 12), random.randint(1, 28))
        rows.append({
            "campaign_id": cid,
            "campaign_name": name,
            "channel": channel,
            "start_date": start.isoformat(),
            "end_date": (start + timedelta(days=random.randint(14, 90))).isoformat(),
            "target_segment": random.choice(SEGMENTS),
            "budget": random.randint(500000, 10000000),
            "status": random.choices(["active", "completed", "planned"], weights=[30, 50, 20])[0],
        })
    return rows


# ==============================================================================
# 5. Campaign Response Data
# ==============================================================================

def generate_campaign_responses(customers, campaigns):
    """Generate campaign response/engagement data."""
    rows = []
    active_custs = [c["customer_id"] for c in customers if c["status"] == "active"]

    for i in range(1, NUM_CAMPAIGN_RESPONSES + 1):
        camp = random.choice(campaigns)
        cust_id = random.choice(active_custs)

        # Funnel: delivered -> opened -> clicked -> converted
        delivered = random.random() < 0.95
        opened = delivered and random.random() < 0.35
        clicked = opened and random.random() < 0.20
        converted = clicked and random.random() < 0.08

        sent_date = date.fromisoformat(camp["start_date"]) + timedelta(days=random.randint(0, 30))

        rows.append({
            "response_id": f"RSP{i:07d}",
            "campaign_id": camp["campaign_id"],
            "customer_id": cust_id,
            "sent_date": sent_date.isoformat(),
            "channel": camp["channel"],
            "delivered": int(delivered),
            "opened": int(opened),
            "clicked": int(clicked),
            "converted": int(converted),
            "conversion_amount": random.randint(10000, 5000000) if converted else 0,
        })
    return rows


# ==============================================================================
# 6. Web Event Data
# ==============================================================================

def generate_web_events(customers):
    """Generate web/app event log data (JSON Lines)."""
    pages = ["/top", "/deposit", "/loan", "/investment", "/campaign", "/mypage", "/transfer", "/settings"]
    events = ["page_view", "click", "scroll", "form_submit", "button_click"]
    devices = ["smartphone", "pc", "tablet"]
    referrers = ["direct", "google", "yahoo", "portal", "email_link", "push_link"]
    active_custs = [c["customer_id"] for c in customers if c["status"] == "active"]

    rows = []
    now = datetime.now()
    start_dt = now - timedelta(days=90)

    for i in range(1, NUM_WEB_EVENTS + 1):
        ts = start_dt + timedelta(seconds=random.randint(0, int((now - start_dt).total_seconds())))
        rows.append({
            "session_id": f"SES{random.randint(100000, 999999)}",
            "customer_id": random.choice(active_custs) if random.random() < 0.7 else None,
            "timestamp": ts.isoformat(),
            "page_url": random.choice(pages),
            "event_type": random.choices(events, weights=[40, 25, 15, 10, 10])[0],
            "device_type": random.choices(devices, weights=[60, 30, 10])[0],
            "referrer": random.choice(referrers),
        })
    return rows


# ==============================================================================
# Write helpers
# ==============================================================================

def write_csv(data: list[dict], subdir: str, filename: str) -> str:
    """Write list of dicts to CSV file."""
    dirpath = ensure_dir(subdir)
    filepath = os.path.join(dirpath, filename)
    with open(filepath, "w", newline="", encoding="utf-8") as f:
        writer = csv.DictWriter(f, fieldnames=data[0].keys())
        writer.writeheader()
        writer.writerows(data)
    return filepath


def write_jsonl(data: list[dict], subdir: str, filename: str) -> str:
    """Write list of dicts to JSON Lines file."""
    dirpath = ensure_dir(subdir)
    filepath = os.path.join(dirpath, filename)
    with open(filepath, "w", encoding="utf-8") as f:
        for row in data:
            f.write(json.dumps(row, ensure_ascii=False, default=str) + "\n")
    return filepath


# ==============================================================================
# Main
# ==============================================================================

def main():
    print("=" * 60)
    print(f"  ARCADIA Sample Data Generator")
    print(f"  Project: {PROJECT_SLUG}")
    print("=" * 60)

    # 1. Customers
    customers = generate_customers()
    path = write_csv(customers, "customers", "customers.csv")
    print_status("1/6", f"Customers: {len(customers)} records -> {path}")

    # 2. Accounts
    accounts = generate_accounts(customers)
    path = write_csv(accounts, "accounts", "accounts.csv")
    print_status("2/6", f"Accounts: {len(accounts)} records -> {path}")

    # 3. Transactions
    transactions = generate_transactions(accounts)
    path = write_csv(transactions, "transactions", "transactions.csv")
    print_status("3/6", f"Transactions: {len(transactions)} records -> {path}")

    # 4. Campaigns
    campaigns = generate_campaigns()
    path = write_csv(campaigns, "campaigns", "campaigns.csv")
    print_status("4/6", f"Campaigns: {len(campaigns)} records -> {path}")

    # 5. Campaign Responses
    responses = generate_campaign_responses(customers, campaigns)
    path = write_csv(responses, "campaign_responses", "campaign_responses.csv")
    print_status("5/6", f"Campaign Responses: {len(responses)} records -> {path}")

    # 6. Web Events
    web_events = generate_web_events(customers)
    path = write_jsonl(web_events, "web_events", "web_events.json")
    print_status("6/6", f"Web Events: {len(web_events)} records -> {path}")

    # Summary
    print("=" * 60)
    print("  Data Generation Complete")
    print("=" * 60)
    print(f"  Output directory: {OUTPUT_DIR}")
    print(f"  Customers          : {len(customers):>8,} (CSV)")
    print(f"  Accounts           : {len(accounts):>8,} (CSV)")
    print(f"  Transactions       : {len(transactions):>8,} (CSV)")
    print(f"  Campaigns          : {len(campaigns):>8,} (CSV)")
    print(f"  Campaign Responses : {len(responses):>8,} (CSV)")
    print(f"  Web Events         : {len(web_events):>8,} (JSON Lines)")
    print("=" * 60)


if __name__ == "__main__":
    main()
