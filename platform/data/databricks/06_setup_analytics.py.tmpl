# ==============================================================================
# ARCADIA Data Platform - Databricks Analytics Setup
# Generated by ARCADIA Framework (Phase F)
#
# Validates SQL queries against Gold tables and prepares for:
#   - Genie Space (natural language analytics)
#   - AI/BI Dashboard (visual analytics)
#
# Note: Genie Space and AI/BI Dashboard are created via GUI.
#       This script validates the SQL queries to be used.
# ==============================================================================

# Databricks notebook source

# MAGIC %md
# MAGIC # 06. Analytics Setup - Query Validation & Dashboard Preparation
# MAGIC
# MAGIC Validate SQL queries for Genie Space and AI/BI Dashboard.
# MAGIC
# MAGIC > **Note:** Genie Space and AI/BI Dashboard are created via Databricks GUI.
# MAGIC > This notebook validates the SQL queries and provides setup instructions.

# COMMAND ----------

# MAGIC %run ../common/00_config

# COMMAND ----------

CATALOG = catalog_name()

# COMMAND ----------

# MAGIC %md
# MAGIC ## 1. Genie Space - Sample Queries
# MAGIC
# MAGIC Register these as sample questions in your Genie Space
# MAGIC for natural language query baseline.

# COMMAND ----------

# MAGIC %md
# MAGIC ### Q1: How many new accounts were opened last month?

# COMMAND ----------

df = spark.sql(f"""
    SELECT
        account_type,
        COUNT(*) AS new_accounts,
        SUM(CASE WHEN balance > 0 THEN balance ELSE 0 END) AS total_initial_balance
    FROM {fqn(SCHEMA_SILVER, 'accounts')}
    WHERE open_date >= DATE_TRUNC('MONTH', ADD_MONTHS(CURRENT_DATE(), -1))
      AND open_date < DATE_TRUNC('MONTH', CURRENT_DATE())
    GROUP BY account_type
    ORDER BY new_accounts DESC
""")
display(df)

# COMMAND ----------

# MAGIC %md
# MAGIC ### Q2: Customer count and average balance by segment?

# COMMAND ----------

df = spark.sql(f"""
    SELECT
        segment,
        COUNT(*) AS customer_count,
        ROUND(AVG(total_balance), 0) AS avg_balance,
        ROUND(AVG(tx_count_12m), 1) AS avg_tx_count,
        ROUND(AVG(open_rate), 2) AS avg_open_rate
    FROM {fqn(SCHEMA_GOLD, 'customer_360')}
    WHERE status = 'active'
    GROUP BY segment
    ORDER BY customer_count DESC
""")
display(df)

# COMMAND ----------

# MAGIC %md
# MAGIC ### Q3: Campaign ROI ranking?

# COMMAND ----------

df = spark.sql(f"""
    SELECT
        campaign_name,
        channel,
        total_sent,
        total_converted,
        CONCAT(CAST(conversion_rate AS STRING), '%') AS conversion_rate,
        FORMAT_NUMBER(total_revenue, 0) AS revenue,
        FORMAT_NUMBER(budget, 0) AS budget,
        CONCAT(CAST(roi_pct AS STRING), '%') AS roi
    FROM {fqn(SCHEMA_GOLD, 'campaign_effectiveness')}
    WHERE total_sent > 0
    ORDER BY roi_pct DESC
""")
display(df)

# COMMAND ----------

# MAGIC %md
# MAGIC ### Q4: Channel-wise transaction trends?

# COMMAND ----------

df = spark.sql(f"""
    SELECT
        DATE_TRUNC('WEEK', transaction_date) AS week,
        channel,
        SUM(tx_count) AS total_tx,
        SUM(total_credit) AS total_credit,
        SUM(unique_customers) AS unique_customers
    FROM {fqn(SCHEMA_GOLD, 'daily_summary')}
    GROUP BY DATE_TRUNC('WEEK', transaction_date), channel
    ORDER BY week DESC, total_tx DESC
""")
display(df)

# COMMAND ----------

# MAGIC %md
# MAGIC ### Q5: Segment distribution?

# COMMAND ----------

df = spark.sql(f"""
    SELECT
        segment,
        COUNT(*) AS customer_count,
        ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 1) AS pct
    FROM {fqn(SCHEMA_GOLD, 'customer_360')}
    WHERE status = 'active'
    GROUP BY segment
    ORDER BY customer_count DESC
""")
display(df)

# COMMAND ----------

# MAGIC %md
# MAGIC ## 2. AI/BI Dashboard Widgets

# COMMAND ----------

# MAGIC %md
# MAGIC ### Widget 1: Segment Distribution (Pie Chart)

# COMMAND ----------

df = spark.sql(f"""
    SELECT
        segment,
        COUNT(*) AS customer_count,
        ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 1) AS pct
    FROM {fqn(SCHEMA_GOLD, 'customer_360')}
    WHERE status = 'active'
    GROUP BY segment
    ORDER BY customer_count DESC
""")
display(df)

# COMMAND ----------

# MAGIC %md
# MAGIC ### Widget 2: Monthly Transaction Trend (Line Chart)

# COMMAND ----------

df = spark.sql(f"""
    SELECT
        DATE_TRUNC('MONTH', transaction_date) AS month,
        SUM(tx_count) AS total_transactions,
        SUM(total_credit) AS total_credit,
        SUM(total_debit) AS total_debit,
        SUM(unique_customers) AS active_customers
    FROM {fqn(SCHEMA_GOLD, 'daily_summary')}
    GROUP BY DATE_TRUNC('MONTH', transaction_date)
    ORDER BY month
""")
display(df)

# COMMAND ----------

# MAGIC %md
# MAGIC ### Widget 3: Campaign Funnel (Bar Chart)

# COMMAND ----------

df = spark.sql(f"""
    SELECT
        campaign_name,
        total_sent,
        total_delivered,
        total_opened,
        total_clicked,
        total_converted
    FROM {fqn(SCHEMA_GOLD, 'campaign_effectiveness')}
    WHERE total_sent > 0
    ORDER BY total_sent DESC
    LIMIT 10
""")
display(df)

# COMMAND ----------

# MAGIC %md
# MAGIC ### Widget 4: Segment Analysis Matrix (Heatmap)

# COMMAND ----------

df = spark.sql(f"""
    SELECT
        segment,
        region,
        customer_count,
        ROUND(avg_total_balance, 0) AS avg_balance,
        avg_tx_count,
        avg_conversion_rate
    FROM {fqn(SCHEMA_GOLD, 'segment_analysis')}
    ORDER BY segment, region
""")
display(df)

# COMMAND ----------

# MAGIC %md
# MAGIC ### Widget 5: KPI Summary Cards

# COMMAND ----------

df = spark.sql(f"""
    SELECT
        COUNT(*) AS total_active_customers,
        SUM(total_balance) AS total_aum,
        ROUND(AVG(total_balance), 0) AS avg_balance,
        ROUND(AVG(tx_count_12m), 1) AS avg_tx_per_customer,
        SUM(campaigns_converted) AS total_conversions
    FROM {fqn(SCHEMA_GOLD, 'customer_360')}
    WHERE status = 'active'
""")
display(df)

# COMMAND ----------

# MAGIC %md
# MAGIC ## 3. Genie Space Setup Instructions
# MAGIC
# MAGIC 1. **Start** a SQL Warehouse (Serverless recommended)
# MAGIC 2. Navigate to **Genie** -> **New Genie Space**
# MAGIC 3. Add the following Gold tables:
# MAGIC    - `{CATALOG}.gold.customer_360`
# MAGIC    - `{CATALOG}.gold.campaign_effectiveness`
# MAGIC    - `{CATALOG}.gold.daily_summary`
# MAGIC    - `{CATALOG}.gold.segment_analysis`
# MAGIC 4. Set Space name to your project name
# MAGIC 5. Register the sample queries above as **Sample Questions**
# MAGIC
# MAGIC ### Recommended Sample Questions
# MAGIC - "How many new accounts were opened last month?"
# MAGIC - "Show customer count and average balance by segment"
# MAGIC - "Which campaign has the highest ROI?"
# MAGIC - "Show channel-wise transaction trends for the last 3 months"
# MAGIC - "What are the characteristics of premium segment customers?"

# COMMAND ----------

# MAGIC %md
# MAGIC ## 4. AI/BI Dashboard Setup Instructions
# MAGIC
# MAGIC 1. Navigate to **Dashboards** -> **Create Dashboard**
# MAGIC 2. Set dashboard name to your project name
# MAGIC 3. Add the Widget SQL queries above as datasets
# MAGIC 4. Recommended layout:
# MAGIC    - **Top row**: KPI Summary Cards (Widget 5)
# MAGIC    - **Middle left**: Segment Distribution (Widget 1 / Pie Chart)
# MAGIC    - **Middle right**: Monthly Transaction Trend (Widget 2 / Line Chart)
# MAGIC    - **Bottom left**: Campaign Funnel (Widget 3 / Horizontal Bar)
# MAGIC    - **Bottom right**: Segment Analysis (Widget 4 / Table)

# COMMAND ----------

print("=" * 60)
print("  Analytics Setup - Query Validation Complete")
print("=" * 60)
print(f"  Genie Space queries    : 5")
print(f"  Dashboard widgets      : 5")
print()
print("  Next steps:")
print("  1. Start your SQL Warehouse")
print("  2. Create Genie Space via GUI")
print("  3. Create AI/BI Dashboard via GUI")
print("=" * 60)
